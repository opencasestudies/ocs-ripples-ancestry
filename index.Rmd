---
title: "Ripples Ancestry Plot"
author: "Kate Isaac"
date: "2024-12-20"
output: html_document
---

```{r}
library(readr)
library(ggplot2)
library(tidyverse)

ancestry_props <- read_delim("~/Documents/resources/papers/ripples/NC.admixture_results.with_fam.Q", col_names = FALSE, delim=" ")
colnames(ancestry_props) <- c("pop", "id", paste0("k", c(2:7)))
ancestry_props <- ancestry_props %>%
  separate(col = id, into = c("id", "k1"), sep="\t") %>%
  mutate(k1 = as.double(k1),
         pop = factor(case_when(pop == "ACB" ~ "African Caribbean",
                         pop == "ASW" ~ "African American",
                         pop == "CHB" ~ "Han Chinese",
                         pop == "Egyptians" ~ "Egyptian",
                         pop == "ESN" ~ "Esan",
                         pop == "GBR" ~ "British",
                         pop == "GIH" ~ "Gujarati",
                         pop == "GWD" ~ "Mandinka",
                         pop == "LWK" ~ "Luhya",
                         pop == "MSL" ~ "Mende",
                         pop == "MXL" ~ "Mexican",
                         pop == "Nama/Khoe-San" ~ "Nama",
                         pop == "RwandeseUgandan" ~ "Rwandese",
                         pop == "TSI" ~ "Italian",
                         pop == "YRI" ~ "Yoruba",
                         .default = pop),
                      levels = c("Nama", "Zulu", "Mende", "Esan", "Yoruba", "Mandinka", "African Caribbean", "African American", "Banyarwanda", "Banyankole", "Bakiga", "Barundi", "Rwandese", "Baganda", "Luhya", "Gumuz", "Somali", "Wolayta", "Oromo", "Amhara", "Egyptian", "Gujarati", "Mexican", "British", "Italian", "Han Chinese"))
            )

ancestry_props_temp <- ancestry_props
```
Need to add superpopulation labels and sort by those.


```{r}
ancestry_props %>% 
  pivot_longer(starts_with("k"), values_to = "prop", names_to = "which_k") %>%
  ggplot(aes(y=id,
             x=prop,
             fill = which_k,
             group = pop)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~pop, ncol=1, strip.position = "left", scale = "free_y") +
  theme(axis.text.y = element_blank(),
        strip.text.y.left = element_text(angle = 0)) +
  ylab("")

```

```{r}
left_join(ancestry_props_temp %>% select(!starts_with("k")) %>%  rownames_to_column(), ancestry_props_temp %>% select(starts_with("k")) %>% mutate(which_k = names(.)[max.col(.)]) %>% rownames_to_column() %>% select(rowname, which_k), by="rowname") %>% group_by(pop, which_k) %>% summarize(count = n()) %>% ungroup() %>% group_by(pop) %>% top_n(1, count) %>% ggplot(aes(x = -1, y = fct_rev(pop), fill = which_k)) + geom_col(width=1) + theme_bw() +
theme(axis.text.x = element_blank(),
           axis.ticks.x=element_blank(), legend.position = "bottom") + xlab("") + ylab("") + xlim(c(-1,0))
```